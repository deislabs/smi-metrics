name: Release
on:
  push:
    tags:
      - 'v*.*.*'
jobs:
 # Perform the same build stuff
  go_build_test:
    name: Go Build and Test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@master
    - name: Setup Go
      uses: actions/setup-go@v1
      with:
        go-version: 1.12
    - name: Validate go deps
      run: |
        make dep
    - name: Running go linting and unit tests
      run: |
         make lint test
  docker_build:
    name: Docker Build, Push and Release
    needs: go_build_test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@master
    - name: Set env
      run: echo ::set-env name=RELEASE_VERSION::${GITHUB_REF:10}
    - name: Performing a release for
      run: echo $RELEASE_VERSION
    - name: Docker Build and Push
      run: |
        docker login -u ${{ secrets.DOCKER_USER}} -p ${{ secrets.DOCKER_PASS}}  && \
        make release
